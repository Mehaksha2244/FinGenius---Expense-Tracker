{% extends "base.html" %}

{% block title %}âš™ï¸ Settings - Fin Genius{% endblock %}

{% block content %}
<!-- Main Container -->
<div class="main-container">
    <!-- Page Header -->
    <!-- Page Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            Settings
        </h1>
        <p class="dashboard-subtitle">Customize your expense tracking experience! ğŸ¨</p>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="dashboard-grid">
        <!-- User Preferences -->
        <div class="card">
            <h3
                style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                ğŸ¨ Appearance & Preferences
            </h3>

            <form action="{{ url_for('update_settings') }}" method="POST">
                <div class="form-group">
                    <label class="form-label">ğŸ¨ Theme</label>
                    <select name="theme" class="form-input" id="theme-selector">
                        <option value="pastel" {{ 'selected' if preferences.theme=='pastel' else '' }}>ğŸŒ¸ Pastel
                        </option>
                        <option value="dark" {{ 'selected' if preferences.theme=='dark' else '' }}>ğŸŒ™ Dark</option>
                        <option value="neon" {{ 'selected' if preferences.theme=='neon' else '' }}>âš¡ Neon</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ’° Currency</label>
                    <select name="currency" class="form-input">
                        <option value="â‚¹" {{ 'selected' if preferences.currency=='â‚¹' else '' }}>â‚¹ Indian Rupee</option>
                        <option value="$" {{ 'selected' if preferences.currency=='$' else '' }}>$ US Dollar</option>
                        <option value="â‚¬" {{ 'selected' if preferences.currency=='â‚¬' else '' }}>â‚¬ Euro</option>
                        <option value="Â£" {{ 'selected' if preferences.currency=='Â£' else '' }}>Â£ British Pound</option>
                        <option value="Â¥" {{ 'selected' if preferences.currency=='Â¥' else '' }}>Â¥ Japanese Yen</option>
                        <option value="â‚¿" {{ 'selected' if preferences.currency=='â‚¿' else '' }}>â‚¿ Bitcoin</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ”” Notifications</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="budget_alerts" {{ 'checked' if preferences.budget_alerts
                                else '' }}>
                            <span>Budget alerts when approaching limits</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="insights_enabled" {{ 'checked' if preferences.insights_enabled
                                else '' }}>
                            <span>AI insights and recommendations</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    ğŸ’¾ Save Preferences
                </button>
            </form>
        </div>

        <!-- Budget Categories -->
        <div class="card">
            <h3
                style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                ğŸ’³ Budget Categories
            </h3>

            <div id="budget-categories">
                {% for category in budget_categories %}
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small); margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 20px; height: 20px; background: {{ category.color }}; border-radius: 4px;">
                        </div>
                        <span style="color: var(--text-primary); font-weight: 500;">{{ category.category }}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="number" step="0.01" value="{{ category.monthly_limit or 0 }}"
                            style="width: 100px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-small); background: var(--bg-secondary); color: var(--text-primary);"
                            onchange="updateBudgetLimit('{{ category.category }}', this.value)">
                        <span style="color: var(--text-muted); font-size: 0.9rem;">{{ currency }}/month</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button class="btn btn-outline" onclick="addNewCategory()">
                â• Add Category
            </button>
        </div>

        <!-- Data Management -->
        <div class="card">
            <h3
                style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                ğŸ“Š Data Management
            </h3>

            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ğŸ“¤ Export Data</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Download your expense data in various formats for backup or analysis.
                    </p>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-outline btn-sm" onclick="exportData('csv')">ğŸ“Š CSV</button>
                        <button class="btn btn-outline btn-sm" onclick="exportData('json')">ğŸ“„ JSON</button>
                        <button class="btn btn-outline btn-sm" onclick="exportData('pdf')">ğŸ“‹ PDF</button>
                    </div>
                </div>

                <div style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ğŸ“¥ Import Data</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Import expense data from other applications or backup files.
                    </p>
                    <input type="file" id="import-file" accept=".csv,.json" style="display: none;">
                    <button class="btn btn-outline btn-sm" onclick="document.getElementById('import-file').click()">
                        ğŸ“ Choose File
                    </button>
                </div>

                <div style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ğŸ—‘ï¸ Clear Data</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Permanently delete all your expense data. This action cannot be undone!
                    </p>
                    <button class="btn btn-danger btn-sm" onclick="confirmClearData()">
                        ğŸ—‘ï¸ Clear All Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Receipt Scanner Settings -->
        <div class="card">
            <h3
                style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                ğŸ“¸ Receipt Scanner
            </h3>

            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ğŸ”§ OCR Settings</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Configure automatic text recognition for receipt scanning.
                    </p>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-outline btn-sm" onclick="testOCR()">ğŸ§ª Test OCR</button>
                        <button class="btn btn-outline btn-sm" onclick="calibrateOCR()">âš™ï¸ Calibrate</button>
                    </div>
                </div>

                <div style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ğŸ“± Mobile Scanning</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Enable camera access for mobile receipt scanning.
                    </p>
                    <button class="btn btn-outline btn-sm" onclick="enableCamera()">
                        ğŸ“· Enable Camera
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Information -->
        <div class="card">
            <h3
                style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                ğŸ‘¤ Account Information
            </h3>

            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <span style="color: var(--text-primary); font-weight: 500;">Account Type</span>
                    <span style="color: var(--text-secondary);">Free</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <span style="color: var(--text-primary); font-weight: 500;">Storage Used</span>
                    <span style="color: var(--text-secondary);">2.3 MB / 100 MB</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <span style="color: var(--text-primary); font-weight: 500;">Last Backup</span>
                    <span style="color: var(--text-secondary);">2 days ago</span>
                </div>
            </div>

            <div style="margin-top: 1rem;">
                <button class="btn btn-primary" onclick="upgradeAccount()">
                    ğŸš€ Upgrade to Pro
                </button>
            </div>
        </div>

        <!-- Help & Support -->
        <div class="card">
            <h3
                style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                â“ Help & Support
            </h3>

            <div style="space-y: 1rem;">
                <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                    <div class="btn btn-outline"
                        style="text-align: left; justify-content: space-between; cursor: default; opacity: 0.85; width: 100%;">
                        <span style="display: flex; align-items: center; gap: 0.5rem;">ğŸ“– User Guide</span>
                        <span
                            style="background: var(--accent-gradient); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">Coming
                            Soon</span>
                    </div>
                    <div class="btn btn-outline"
                        style="text-align: left; justify-content: space-between; cursor: default; opacity: 0.85; width: 100%;">
                        <span style="display: flex; align-items: center; gap: 0.5rem;">ğŸ¥ Video Tutorials</span>
                        <span
                            style="background: var(--accent-gradient); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">Coming
                            Soon</span>
                    </div>
                    <div class="btn btn-outline"
                        style="text-align: left; justify-content: space-between; cursor: default; opacity: 0.85; width: 100%;">
                        <span style="display: flex; align-items: center; gap: 0.5rem;">ğŸ’¬ Contact Support</span>
                        <span
                            style="background: var(--accent-gradient); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">Coming
                            Soon</span>
                    </div>
                    <div class="btn btn-outline"
                        style="text-align: left; justify-content: space-between; cursor: default; opacity: 0.85; width: 100%;">
                        <span style="display: flex; align-items: center; gap: 0.5rem;">ğŸ› Report Bug</span>
                        <span
                            style="background: var(--accent-gradient); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">Coming
                            Soon</span>
                    </div>
                    <div class="btn btn-outline"
                        style="text-align: left; justify-content: space-between; cursor: default; opacity: 0.85; width: 100%;">
                        <span style="display: flex; align-items: center; gap: 0.5rem;">ğŸ’¡ Feature Request</span>
                        <span
                            style="background: var(--accent-gradient); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">Coming
                            Soon</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize settings page
    document.addEventListener('DOMContentLoaded', function () {
        initializeSettingsPage();
    });

    function initializeSettingsPage() {
        // Initialize theme selector
        const themeSelector = document.getElementById('theme-selector');
        if (themeSelector) {
            themeSelector.addEventListener('change', function () {
                const selectedTheme = this.value;
                // Apply theme immediately using the base.html function if available or manually
                document.documentElement.setAttribute('data-theme', selectedTheme);
                localStorage.setItem('fingenius-theme', selectedTheme);

                // Also update the nav bar toggle if present
                const themeIcon = document.getElementById('theme-icon');
                const themeName = document.getElementById('theme-name');
                if (themeIcon && themeName) {
                    switch (selectedTheme) {
                        case 'pastel':
                            themeIcon.textContent = 'ğŸŒ¸';
                            themeName.textContent = 'Pastel';
                            break;
                        case 'dark':
                            themeIcon.textContent = 'ğŸŒ™';
                            themeName.textContent = 'Dark';
                            break;
                        case 'neon':
                            themeIcon.textContent = 'ğŸ’¡';
                            themeName.textContent = 'Neon';
                            break;
                    }
                }
            });
        }

        // Sync visual selector with stored theme
        const savedTheme = localStorage.getItem('fingenius-theme');
        if (savedTheme && themeSelector) {
            themeSelector.value = savedTheme;
        }

        // Initialize notification toggles
        const notificationToggles = document.querySelectorAll('.notification-toggle');
        notificationToggles.forEach(toggle => {
            toggle.addEventListener('change', function () {
                const settingName = this.name;
                const isEnabled = this.checked;
                // In a real app, this would make an AJAX request to save the setting
                console.log(`Setting ${settingName} changed to ${isEnabled}`);
            });
        });

        // Initialize backup button
        const backupBtn = document.getElementById('backup-btn');
        if (backupBtn) {
            backupBtn.addEventListener('click', function () {
                if (typeof showNotification === 'function') {
                    showNotification('Backup initiated! ğŸ“¦', 'info');
                }
            });
        }
    }

    function updateBudgetLimit(category, limit) {
        if (typeof showNotification === 'function') {
            showNotification(`Budget limit for ${category} updated to ${limit}! ğŸ’°`, 'success');
        }
    }

    function addNewCategory() {
        const categoryName = prompt('Enter new category name:');
        if (categoryName) {
            if (typeof showNotification === 'function') {
                showNotification(`New category "${categoryName}" added! ğŸ·ï¸`, 'success');
            }
        }
    }

    function exportData(format) {
        if (typeof showNotification === 'function') {
            showNotification(`${format.toUpperCase()} export initiated! ğŸ“¤`, 'info');
        }
    }

    function confirmClearData() {
        if (confirm('Are you sure you want to clear all data? This action cannot be undone!')) {
            if (typeof showNotification === 'function') {
                showNotification('All data cleared! ğŸ—‘ï¸', 'warning');
            }
        }
    }

    function testOCR() {
        const btn = document.querySelector('button[onclick="testOCR()"]');
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âŒ› Scanning...';
            btn.disabled = true;

            setTimeout(() => {
                if (typeof showNotification === 'function') {
                    showNotification('OCR Test Successful! Receipt text detected. ğŸ“„', 'success');
                }
                btn.innerHTML = 'âœ… Success';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }, 2000);
        }
    }

    function calibrateOCR() {
        const btn = document.querySelector('button[onclick="calibrateOCR()"]');
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âš™ï¸ Calibrating...';
            btn.disabled = true;

            setTimeout(() => {
                if (typeof showNotification === 'function') {
                    showNotification('OCR Engine calibrated for optimal performance! ğŸš€', 'success');
                }
                btn.innerHTML = 'âœ… Optimized';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }, 2000);
        }
    }

    function enableCamera() {
        const btn = document.querySelector('button[onclick="enableCamera()"]');
        if (btn) btn.disabled = true;

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    if (typeof showNotification === 'function') {
                        showNotification('Camera access granted! ğŸ“¸', 'success');
                    }
                    // Stop stream immediately as this is just a permission check/test
                    stream.getTracks().forEach(track => track.stop());

                    if (btn) {
                        btn.innerHTML = 'âœ… Camera Enabled';
                        btn.classList.add('btn-success');
                        btn.classList.remove('btn-outline');
                    }
                })
                .catch(function (err) {
                    if (typeof showNotification === 'function') {
                        showNotification('Camera access denied or error occurred. âŒ', 'error');
                    }
                    if (btn) btn.disabled = false;
                });
        } else {
            if (typeof showNotification === 'function') {
                showNotification('Camera not supported on this device. ğŸ“±', 'error');
            }
            if (btn) btn.disabled = false;
        }
    }

    function upgradeAccount() {
        if (typeof showNotification === 'function') {
            showNotification('Redirecting to payment gateway... ğŸš€', 'info');
        }
        setTimeout(() => {
            // Simulation of redirect
            if (typeof showNotification === 'function') {
                showNotification('(Simulation) Pro features unlocked in demo! â­', 'success');
            }
        }, 1500);
    }
</script>
{% endblock %}