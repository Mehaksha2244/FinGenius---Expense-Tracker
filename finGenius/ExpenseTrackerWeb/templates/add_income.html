{% extends "base.html" %}

{% block title %}üí∞ Add Income - Fin Genius{% endblock %}

{% block content %}
<!-- Main Container -->
<div class="main-container">
    <!-- Page Header -->
    <!-- Page Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            
            Add New Income
        </h1>
        <p class="dashboard-subtitle">Track your income sources and build your financial future! üöÄ</p>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="dashboard-grid">
        <!-- Add Income Form -->
        <div class="card" style="grid-column: 1 / -1;">
            <h3
                style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                üí∞ Income Details
            </h3>

            <form action="{{ url_for('add_income') }}" method="POST" id="income-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">üìÖ Date *</label>
                        <input type="date" name="date" class="form-input" id="income-date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üè∑Ô∏è Category *</label>
                        <select name="category" class="form-input" id="income-category" required>
                            <option value="">Select a category</option>
                            <option value="Salary">Salary</option>
                            <option value="Freelance">Freelance</option>
                            <option value="Investment">Investment</option>
                            <option value="Gift">Gift</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">üìù Description</label>
                        <input type="text" name="description" class="form-input"
                            placeholder="Source of income (e.g., Monthly Salary, Freelance Project)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üí∞ Amount *</label>
                        <div style="position: relative;">
                            <span
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600;">{{
                                currency }}</span>
                            <input type="number" step="0.01" name="amount" class="form-input" placeholder="0.00"
                                required style="padding-left: 2.5rem;" id="income-amount">
                        </div>
                    </div>
                </div>

                <!-- Quick Amount Buttons -->
                <div class="form-group">
                    <label class="form-label">‚ö° Quick Amounts</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" class="btn btn-outline btn-sm" onclick="setAmount(1000)">{{ currency
                            }}1000</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="setAmount(5000)">{{ currency
                            }}5000</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="setAmount(10000)">{{ currency
                            }}10000</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="setAmount(25000)">{{ currency
                            }}25000</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="setAmount(50000)">{{ currency
                            }}50000</button>
                    </div>
                </div>

                <!-- Form Actions -->
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                        üí∞ Add Income
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline btn-lg">
                        ‚ùå Cancel
                    </a>
                </div>
            </form>
        </div>

        <!-- Tips and Help -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">üí° Pro Tips</h3>
            <div style="color: var(--text-secondary); line-height: 1.6;">
                <div
                    style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <strong>üí∞ Track All Income:</strong> Record all sources of income to get a complete financial
                    picture.
                </div>
                <div
                    style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <strong>üè∑Ô∏è Categorize:</strong> Use consistent categories to analyze your income patterns.
                </div>
                <div style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <strong>üìä Insights:</strong> Regular income tracking helps you understand your earning potential.
                </div>
            </div>
        </div>

        <!-- Recent Income Preview -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">üìã Recent Income</h3>
            <div id="recent-income" style="max-height: 300px; overflow-y: auto;">
                <div class="text-center p-4" style="color: var(--text-muted);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
                    <p>Loading recent income...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize form
    document.addEventListener('DOMContentLoaded', function () {
        initializeAddIncomeForm();
        loadRecentIncome();
    });

    function initializeAddIncomeForm() {
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('income-date');
        if (dateInput) {
            dateInput.value = today;
        }

        // Form validation
        const form = document.getElementById('income-form');
        if (form) {
            form.addEventListener('submit', function (e) {
                const amountInput = document.getElementById('income-amount');
                const amount = parseFloat(amountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    e.preventDefault();
                    if (typeof showNotification === 'function') {
                        showNotification('Please enter a valid amount! üí∞', 'error');
                    }
                    return;
                }

                // Save to local storage for "Recent Income" preview
                const category = document.getElementById('income-category').value;
                const description = document.querySelector('input[name="description"]').value || category;
                const date = document.getElementById('income-date').value;

                const newIncome = {
                    date, category, description, amount,
                    timestamp: new Date().getTime()
                };

                const recent = JSON.parse(localStorage.getItem('fingenius_recent_income') || '[]');
                recent.unshift(newIncome);
                if (recent.length > 5) recent.pop(); // Keep last 5
                localStorage.setItem('fingenius_recent_income', JSON.stringify(recent));

                // Show loading state
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.innerHTML = '‚è≥ Adding...';
                // Let form submit
            });
        }
    }

    function loadRecentIncome() {
        const container = document.getElementById('recent-income');
        if (!container) return;

        const recent = JSON.parse(localStorage.getItem('fingenius_recent_income') || '[]');

        if (recent.length === 0) {
            container.innerHTML = `
                <div class="text-center p-4" style="color: var(--text-muted);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üí∞</div>
                    <p>No recently added income found.</p>
                </div>`;
            return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
        recent.forEach(income => {
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.2rem;">üí∞</span>
                        <div>
                            <div style="font-weight: 500; color: var(--text-primary);">${income.category}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${income.description}</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--success-color);">+{{ currency }}${income.amount.toFixed(2)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${income.date}</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function setAmount(amount) {
        const amountInput = document.getElementById('income-amount');
        if (amountInput) {
            amountInput.value = amount;
            amountInput.focus();
        }
    }

    // Real-time amount formatting
    const amountInput = document.getElementById('income-amount');
    if (amountInput) {
        amountInput.addEventListener('input', function () {
            const value = parseFloat(this.value);
            if (!isNaN(value) && value > 0) {
                // You could add real-time validation or formatting here
            }
        });
    }
</script>
{% endblock %}