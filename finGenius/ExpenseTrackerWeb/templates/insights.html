{% extends "base.html" %}

{% block title %}ğŸ§  Insights - Fin Genius{% endblock %}

{% block content %}
<!-- Main Container -->
<div class="main-container">
    <!-- Page Header -->
    <!-- Page Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            AI-Powered Insights
        </h1>
        <p class="dashboard-subtitle">Discover patterns, get personalized recommendations, and optimize your spending!
            ğŸš€</p>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- AI Insights Cards -->
    <div class="dashboard-grid">
        <!-- Main Insights -->
        <div class="card" style="grid-column: 1 / -1;">
            <h3
                style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                ğŸ¤– AI-Generated Insights
                <button class="btn btn-sm btn-outline" onclick="refreshInsights()"
                    style="margin-left: auto; font-size: 0.8rem;">
                    ğŸ”„ Refresh
                </button>
            </h3>
            <div id="insights-container">
                {% for insight in insights %}
                <div class="insight-card" style="animation: fadeInUp 0.6s ease {{ loop.index0 * 0.1 }}s both;">
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <span class="insight-emoji">ğŸ’¡</span>
                        <div>
                            <p class="insight-text">{{ insight }}</p>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Generated Today
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if not insights %}
                <div class="text-center p-4" style="color: var(--text-muted);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ¤–</div>
                    <h4>No insights yet!</h4>
                    <p>Add more expenses to get personalized AI insights and recommendations.</p>
                    <a href="{{ url_for('add_expense') }}" class="btn btn-primary" style="margin-top: 1rem;">
                        â• Add Expenses
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Spending Analysis Chart -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">ğŸ“Š Category Breakdown</h3>
            <div class="chart-container">
                <canvas id="categoryChart" data-chart-data="{{ category_data|tojson }}"></canvas>
            </div>
            <div
                style="margin-top: 1rem; padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ğŸ’¡ Analysis</h4>
                {% if category_data %}
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    Your top spending category is <strong>{{ category_data[0].category }}</strong>
                    with {{ currency }}{{ "%.2f"|format(category_data[0].total) }}
                    ({{ "%.1f"|format((category_data[0].total / category_data|sum(attribute='total') * 100)) }}% of
                    total spending).
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Monthly Trends Chart -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">ğŸ“ˆ Spending Trends</h3>
            <div class="chart-container">
                <canvas id="monthlyChart" data-chart-data="{{ monthly_trends|tojson }}"></canvas>
            </div>
            <div
                style="margin-top: 1rem; padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ğŸ“Š Trend Analysis</h4>
                {% if monthly_trends|length >= 2 %}
                {% set current_month = monthly_trends[-1].total %}
                {% set previous_month = monthly_trends[-2].total %}
                {% set change = ((current_month - previous_month) / previous_month * 100) if previous_month > 0 else 0
                %}
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    {% if change > 0 %}
                    ğŸ“ˆ Spending increased by <strong>{{ "%.1f"|format(change) }}%</strong> compared to last month.
                    {% elif change < 0 %} ğŸ“‰ Spending decreased by <strong>{{ "%.1f"|format(-change) }}%</strong>
                        compared to last month. Great job! ğŸ‰
                        {% else %}
                        ğŸ“Š Spending remained the same as last month.
                        {% endif %}
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Mood Analysis -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">ğŸ˜Š Mood vs Spending</h3>
            <div class="chart-container">
                <canvas id="moodChart" data-chart-data="{{ mood_analysis|tojson }}"></canvas>
            </div>
            <div
                style="margin-top: 1rem; padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ğŸ§  Mood Insights</h4>
                {% if mood_analysis %}
                {% set top_mood = mood_analysis[0] %}
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    You spend the most when feeling <strong>{{ top_mood.mood }}</strong>
                    ({{ currency }}{{ "%.2f"|format(top_mood.total) }} total).
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Spending Patterns -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">ğŸ” Spending Patterns</h3>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div
                    style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small); margin-bottom: 1rem;">
                    <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">ğŸ“… Weekly Pattern</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Analyze which days of the week you spend the most to optimize your budget planning.
                    </p>
                    <div style="margin-top: 0.5rem;">
                        <span
                            style="background: var(--accent-gradient); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.8rem;">
                            Coming Soon
                        </span>
                    </div>
                </div>

                <div
                    style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small); margin-bottom: 1rem;">
                    <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">â° Time Analysis</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Discover peak spending hours and optimize your shopping schedule.
                    </p>
                    <div style="margin-top: 0.5rem;">
                        <span
                            style="background: var(--accent-gradient); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.8rem;">
                            Coming Soon
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">ğŸ’¡ Smart Recommendations</h3>
            <div id="recommendations">
                <div
                    style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small); margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">ğŸ¯</span>
                        <h4 style="color: var(--text-primary); margin: 0;">Set a Budget Goal</h4>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Based on your spending patterns, consider setting a monthly budget goal.
                    </p>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="{{ url_for('goals') }}" class="btn btn-primary btn-sm">Set Goal</a>
                        <button class="btn btn-sm btn-outline"
                            onclick="showNotification('Budget goal recommendation noted! We\'ll remind you to set one. ğŸ¯', 'info')">Later</button>
                    </div>
                </div>

                <div
                    style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small); margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">ğŸ“Š</span>
                        <h4 style="color: var(--text-primary); margin: 0;">Track Daily</h4>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Consistent daily tracking helps identify spending patterns faster.
                    </p>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="{{ url_for('add_expense') }}" class="btn btn-outline btn-sm">Add Expense</a>
                        <button class="btn btn-sm btn-outline"
                            onclick="showNotification('Daily tracking reminder set for tomorrow! ğŸ“…', 'success')">Remind
                            Me</button>
                    </div>
                </div>

                <div style="padding: 1rem; background: var(--bg-glass); border-radius: var(--border-radius-small);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">ğŸ“±</span>
                        <h4 style="color: var(--text-primary); margin: 0;">Use Receipt Scanning</h4>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Upload receipts for automatic amount detection and better accuracy.
                    </p>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="{{ url_for('scan_receipt') }}" class="btn btn-outline btn-sm">Scan Receipt</a>
                        <button class="btn btn-sm btn-outline"
                            onclick="showNotification('Receipt scanning tip saved! You can access it anytime from the Scan Receipt page. ğŸ“¸', 'info')">Save
                            Tip</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Health Score -->
        <div class="card" style="background: var(--accent-gradient); color: white;">
            <h3 style="margin-bottom: 1rem; color: white;">ğŸ† Financial Health Score</h3>
            <div style="text-align: center; margin: 2rem 0;">
                <div style="font-size: 4rem; font-weight: 700; margin-bottom: 0.5rem;" id="health-score">85</div>
                <div style="font-size: 1.2rem; margin-bottom: 1rem;">Out of 100</div>
                <div class="progress-container" style="background: rgba(255, 255, 255, 0.3);">
                    <div class="progress-bar" style="width: 85%; background: white;"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn btn-light" onclick="generateHealthScore()" style="margin: 0 0.5rem;">
                    ğŸ”„ Update Score
                </button>
                <button class="btn btn-light" onclick="exportInsights()" style="margin: 0 0.5rem;">
                    ğŸ“„ Export Report
                </button>
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <p style="margin: 0; font-style: italic;">
                    "Great job! You're on track to achieve your financial goals! ğŸš€"
                </p>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="card" style="text-align: center; margin-top: 2rem;">
        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">ğŸš€ Take Action</h3>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="{{ url_for('add_expense') }}" class="btn btn-primary btn-lg">
                â• Add New Expense
            </a>
            <a href="{{ url_for('goals') }}" class="btn btn-secondary btn-lg">
                ğŸ¯ Set Financial Goals
            </a>
            <a href="{{ url_for('settings') }}" class="btn btn-outline btn-lg">
                âš™ï¸ Adjust Settings
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize insights page
    document.addEventListener('DOMContentLoaded', function () {
        initializeInsightsPage();
        initializeCharts();
    });

    function initializeInsightsPage() {
        // Animate insight cards
        const insightCards = document.querySelectorAll('.insight-card');
        insightCards.forEach((card, index) => {
            // Animation is handled by CSS, but we can add additional effects here if needed
            card.style.opacity = '0';
            setTimeout(() => {
                card.style.opacity = '1';
            }, index * 100);
        });
    }

    // Initialize charts
    function initializeCharts() {
        // Category Breakdown Chart
        const categoryCanvas = document.getElementById('categoryChart');
        if (categoryCanvas) {
            const categoryData = JSON.parse(categoryCanvas.dataset.chartData || '[]');
            if (categoryData.length > 0) {
                const categories = categoryData.map(item => item.category);
                const amounts = categoryData.map(item => Math.abs(item.total));

                new Chart(categoryCanvas.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: amounts,
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40',
                                '#8AC926',
                                '#1982C4',
                                '#6A4C93',
                                '#F15BB5'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }
        }

        // Monthly Trends Chart
        const monthlyCanvas = document.getElementById('monthlyChart');
        if (monthlyCanvas) {
            const monthlyData = JSON.parse(monthlyCanvas.dataset.chartData || '[]');
            if (monthlyData.length > 0) {
                const months = monthlyData.map(item => item.month);
                const totals = monthlyData.map(item => Math.abs(item.total));

                new Chart(monthlyCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Monthly Spending',
                            data: totals,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        // Mood Analysis Chart
        const moodCanvas = document.getElementById('moodChart');
        if (moodCanvas) {
            const moodData = JSON.parse(moodCanvas.dataset.chartData || '[]');
            if (moodData.length > 0) {
                const moods = moodData.map(item => item.mood);
                const totals = moodData.map(item => Math.abs(item.total));

                new Chart(moodCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: moods,
                        datasets: [{
                            label: 'Spending by Mood',
                            data: totals,
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }
    }

    function requestNewInsight() {
        if (typeof showNotification === 'function') {
            showNotification('New insight generation coming soon! ğŸ¤–', 'info');
        } else {
            alert('New insight generation coming soon! ğŸ¤–');
        }
    }

    function saveInsight(insightId) {
        if (typeof showNotification === 'function') {
            showNotification('Insight saved to favorites! â¤ï¸', 'success');
        }
    }

    function shareInsight(insightId) {
        if (typeof showNotification === 'function') {
            showNotification('Insight shared successfully! ğŸ“¤', 'success');
        }
    }

    // Refresh insights
    function refreshInsights() {
        if (typeof showNotification === 'function') {
            showNotification('Refreshing insights... ğŸ”„', 'info');
        }
        // In a real implementation, this would fetch new insights from the server
        setTimeout(() => {
            if (typeof showNotification === 'function') {
                showNotification('Insights refreshed successfully! âœ¨', 'success');
            }
        }, 1500);
    }

    // Export insights
    function exportInsights() {
        if (typeof showNotification === 'function') {
            showNotification('Exporting insights to PDF... ğŸ“„', 'info');
        }
        // In a real implementation, this would generate a PDF report
        setTimeout(() => {
            if (typeof showNotification === 'function') {
                showNotification('Insights exported successfully! Check your downloads. ğŸ“', 'success');
            }
        }, 2000);
    }

    // Generate financial health score
    function generateHealthScore() {
        const scoreElement = document.getElementById('health-score');
        if (scoreElement) {
            // Animate the score change
            const currentScore = parseInt(scoreElement.textContent);
            const newScore = Math.min(100, Math.max(0, currentScore + (Math.random() * 10 - 5))); // Random change between -5 and +5

            // Animate the change
            scoreElement.style.transform = 'scale(1.2)';
            scoreElement.style.transition = 'all 0.3s ease';

            setTimeout(() => {
                scoreElement.textContent = Math.round(newScore);
                scoreElement.style.transform = 'scale(1)';

                // Update progress bar
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.width = newScore + '%';
                    progressBar.style.transition = 'width 0.5s ease';
                }

                if (typeof showNotification === 'function') {
                    showNotification('Financial health score updated! ğŸ†', 'success');
                }
            }, 300);
        }
    }
</script>
{% endblock %}